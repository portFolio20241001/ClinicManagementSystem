<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Smart Clinic - Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 font-sans">
  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header class="bg-blue-900 text-white p-4 flex justify-between items-center shadow">
    <h1 class="text-xl font-bold">Smart Clinic Admin Dashboard</h1>
    <button onclick="logout()" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
  </header>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ ãƒ¡ã‚¤ãƒ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main class="max-w-6xl mx-auto mt-8 p-6 bg-white rounded shadow">

    <!-- ã‚¿ã‚¤ãƒˆãƒ« & æ–°è¦ -->
    <div class="flex justify-between items-center mb-6">
      <h2 class="text-2xl font-bold text-blue-800">åŒ»å¸«ä¸€è¦§</h2>
      <a href="/html/doctorCreate.html"
         class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded shadow">æ–°è¦åŒ»å¸«ç™»éŒ²</a>
    </div>

    <!-- ğŸ” æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="flex flex-wrap gap-4 mb-6">
      <input id="nameFilter" type="text" placeholder="åŒ»å¸«åã§æ¤œç´¢"
             class="flex-1 min-w-[160px] border rounded px-3 py-2"
      />
      <input id="specFilter" type="text" placeholder="å°‚é–€ã§æ¤œç´¢"
             class="flex-1 min-w-[160px] border rounded px-3 py-2"
      />
      <button id="searchBtn"
              class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">æ¤œç´¢</button>
      <button id="resetBtn"
              class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="overflow-x-auto">
      <table class="min-w-full table-auto border border-gray-300 text-sm">
        <thead class="bg-gray-200">
          <tr>
            <th class="px-4 py-2 border">åŒ»å¸«å</th>
            <th class="px-4 py-2 border">å°‚é–€</th>
            <th class="px-4 py-2 border">é›»è©±ç•ªå·</th>
            <th class="px-4 py-2 border">ã‚¯ãƒªãƒ‹ãƒƒã‚¯</th>
            <th class="px-4 py-2 border">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="doctorTableBody" class="text-gray-700"></tbody>
      </table>
    </div>
  </main>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ ã‚¹ã‚¯ãƒªãƒ—ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <script>
    const tbody = document.getElementById("doctorTableBody");
    const nameInput  = document.getElementById("nameFilter");
    const specInput  = document.getElementById("specFilter");
    const searchBtn = document.getElementById("searchBtn");
    const resetBtn  = document.getElementById("resetBtn");

    let doctorsCache = [];   // â† ä¸€åº¦å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ

    /* ---------------- åˆæœŸãƒ­ãƒ¼ãƒ‰ ---------------- */
    async function fetchDoctors() {
      const token = localStorage.getItem("token");
      const res   = await fetch("/doctor", { headers: { Authorization: "Bearer " + token } });
      if (!res.ok) { alert("åŒ»å¸«ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ"); return; }
      const data  = await res.json();
      doctorsCache = data.doctors ?? [];
      renderTable(doctorsCache);
    }

    /* ---------------- ãƒ†ãƒ¼ãƒ–ãƒ«æç”» ---------------- */
    function renderTable(list) {
      tbody.innerHTML = "";
      if (list.length === 0) {
        tbody.innerHTML =
          `<tr><td colspan="5" class="text-center py-6 text-gray-500">è©²å½“ã™ã‚‹åŒ»å¸«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</td></tr>`;
        return;
      }
      list.forEach(d => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50";
        tr.innerHTML = `
          <td class="border px-4 py-2">${d.user?.fullName ?? "æœªç™»éŒ²"}</td>
          <td class="border px-4 py-2">${d.specialty       ?? "æœªè¨­å®š"}</td>
          <td class="border px-4 py-2">${d.phone           ?? "ä¸æ˜"}</td>
          <td class="border px-4 py-2">${d.clinicLocation?.name ?? "æœªè¨­å®š"}</td>
          <td class="border px-4 py-2 space-x-2">
            <a href="/html/doctorDetail.html?id=${d.id}"
               class="bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded">è©³ç´°</a>
            <a href="/html/doctorEdit.html?id=${d.id}"
               class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded">æ›´æ–°</a>
            <button onclick="deleteDoctor(${d.id})"
                    class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">å‰Šé™¤</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    /* ---------------- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ---------------- */
    function applyFilter() {
      const nameKey = nameInput.value.trim();
      const specKey = specInput.value.trim();
      const filtered = doctorsCache.filter(d => {
        const nameMatch = !nameKey || (d.user?.fullName ?? "").includes(nameKey);
        const specMatch = !specKey || (d.specialty      ?? "").includes(specKey);
        return nameMatch && specMatch;
      });
      renderTable(filtered);
    }

    /* ---------------- å‰Šé™¤ ---------------- */
    async function deleteDoctor(id) {
      if (!confirm("ã“ã®åŒ»å¸«ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
      const token = localStorage.getItem("token");
      const res   = await fetch(`/doctor/${id}`, { method:"DELETE",
                          headers:{ Authorization:"Bearer " + token } });
      if (res.ok) {
        alert("å‰Šé™¤ã«æˆåŠŸã—ã¾ã—ãŸã€‚");
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã‚‚å‰Šé™¤
        doctorsCache = doctorsCache.filter(d => d.id !== id);
        applyFilter();
      } else {
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      }
    }

    /* ---------------- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ---------------- */
    function logout() {
      localStorage.clear();
      location.href = "/login";
    }

    /* ---------------- ã‚¤ãƒ™ãƒ³ãƒˆ ---------------- */
    document.addEventListener("DOMContentLoaded", fetchDoctors);
    searchBtn.addEventListener("click", applyFilter);
    resetBtn.addEventListener("click", () => { nameInput.value = specInput.value = ""; renderTable(doctorsCache); });
    // Enter ã‚­ãƒ¼ã§å³æ¤œç´¢
    [nameInput, specInput].forEach(inp => inp.addEventListener("keyup", e => { if (e.key === "Enter") applyFilter(); }));
  </script>
</body>
</html>
